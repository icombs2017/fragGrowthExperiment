---
title: "Surface Area Analysis"
author: "Ian Combs -- icombs@mote.org"
output:
  html_document:
    theme: flatly
    code_folding: show
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_doctument:
      toc: yes
      toc_depth: 3
---
```{r, setup, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, fig.align = 'left')
knitr::opts_knit$set(root.dir = "../data")
options(width = 88)
library(magrittr)
```

### version: `r Sys.Date() %>% format(format="%B %d, %Y")`

<!-- this is where the DOI would go  [![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.3675991.svg)](https://doi.org/10.5281/zenodo.3675991)
-->


#### [GitHub repository](https://github.com/icombs2017/fragGrowthExperiment.git){target="_blank"}
###

***
This is the working analysis pipeline to analyze data generated from 3D models of micro-fragmented coral colonies and larger frags to assess differences in growth rates between microfragments and natural growth. 

***

### All analyses performed with R version `r getRversion()`


# Basic setup of R environment
***
## Loading required packages
For the following analyses we will require the use of a number of different R packages. Most of which can be sourced from CRAN, but some must be downloaded from GitHub. We can use the following code to load in the packages and install any packages not previously installed in the R console. 


```{r,packages, include = TRUE, message = FALSE, warning = FALSE, results = 'hide'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load("ggplot2", "googlesheets4", "dplyr", "officer","reshape2", "stringr", "dplyr", "flextable", "gridExtra", "ggpubr", "Rmisc", "rcompanion", "RColorBrewer", "vegan", "googledrive", "gdata", "readxl", "DescTools","patchwork","reshape2", "FSA", 'vegan', 'pairwiseAdonis')




```


# Importing Data
***
## We are downloading this dataset from our GoogleDrive folder. We will be using the package `googledrive`. Each GoogleDrive file has a unique ID that does not change throughout the lifespan of the document, even if the file name is changed. This ID is housed in the file's URL. 
Example: docs.google.com/spreadsheets/d/FILE_ID_GOES_HERE/other_information/. Below you will copy and paste that into the function `drive_download` within `as_id`. This will save the file locally in the specified path (in this case our data folder) and you will import the folder as you normally would. Downloading it this way decreases the potential human error when downloading, moving folders, renaming, saving etc and ensures that the most up to date file is being utilized. 



```{r, loadingData, include = TRUE}

drive_download(
  as_id("1l_cfPBmGMb7FfflpvSLBZi6Ma42Q7pr1uK_fwk0mz40"),
  path = "../data/saDataset.xlsx", 
  overwrite = TRUE)

sa <- read_excel("../data/saDataset.xlsx")
sa

```



## Now I am just tidying up my dataset, I am combining two columns, **species** and **genotype** into a column **geno** using the `paste0` function, cleaning up the raw dataset to only include my species of concern using multiple functions from the package `dplyr`, and changing the class of some variables to factors using the function `as.factor()` for easier manipulation down the road. 


```{r, dataManipulation, include = TRUE}

sa$genotype <- as.character(sa$genotype)

sa$geno <- paste0(sa$species, sa$genotype)

saClean <- sa %>% 
  select("timePoint", "species","geno", "trial", "ID", "Surface Area (cm2)") %>% 
  dplyr::filter(species %in% c("pc", "dl")) %>% 
  dplyr::rename("surfaceArea" = "Surface Area (cm2)")


saClean$timePoint <- as.factor(saClean$timePoint)

saClean$species <- as.factor(saClean$species)

saClean$geno <- as.factor(saClean$geno)

saClean$trial <- as.factor(saClean$trial)

saClean$ID <- as.factor(saClean$ID)


head(saClean)




```
### Here we are breaking the data apart into frags and wilds, combinging the frags from each trial, putting the data back together, and then calculating percent change of surface area between the first and last timepoint. We are using a number of functions from the package `dplyr` as well as the function `dcast()` to recombine data from the package `reshape2` 


```{r, calculatingPercentChange, include = TRUE }

saFrag <- saClean %>% 
  select(timePoint, geno, ID, surfaceArea) %>% 
  dplyr::filter(ID %in% 'frag') %>%
  dplyr::group_by(timePoint,geno,ID) %>% 
  dplyr::summarise(sum(surfaceArea)) %>% 
  dplyr::rename("surfaceArea" = "sum(surfaceArea)")


saWild <- saClean %>% 
  dplyr::filter(ID %in% 'wild') %>% 
  select(timePoint, geno, ID, surfaceArea)


# saCombo <- left_join(saFrag, saWild, by = c("timePoint","geno"), copy = FALSE) %>% 
  # dplyr::rename(fragSA = surfaceArea.x) %>% 
  # dplyr::rename(wildSA = surfaceArea.y)

saCombo <- bind_rows(saFrag,saWild)


saFinal <- saCombo %>% 
  dplyr::filter(timePoint %in% c("0","4")) %>%
  select(c('timePoint','geno','ID','surfaceArea'))


length(saFinal$timePoint)

saChange <- dcast(saFinal, geno+ID~timePoint) 

saChange <- dplyr::rename(saChange, "initialSurfaceArea" = "0", "finalSurfaceArea" = "4")
saChange
saChange$percentChange <- ((saChange$finalSurfaceArea-saChange$initialSurfaceArea)/saChange$initialSurfaceArea)*100


saFragTest <- saChange %>% 
  select(geno, ID, percentChange) %>% 
  dplyr::filter(ID %in% 'frag') %>%
  dplyr::group_by(geno,ID)
  #dplyr::summarise(sum(surfaceArea)) %>% 
  #dplyr::rename("surfaceArea" = "sum(surfaceArea)")


saWildTest <- saChange %>% 
  dplyr::filter(ID %in% 'wild') %>% 
  select(geno, ID, percentChange)


saCombo <- left_join(saFragTest, saWildTest, by = c("geno"), copy = FALSE) %>% 
  dplyr::rename(fragpercentChange = percentChange.x) %>% 
  dplyr::rename(wildpercentChange = percentChange.y)












```


Now we will run a paired t-test to determine if the percent change in surface area of the frags varies from the wilds. First, we need to assess normality via the shapiro-wilk test for normal distribution and the Leven's Test to test for homogeneity of variance. If neither is significant, we will conduct a t-test.

```{r, t-test, include = TRUE}

shapiro.test(saChange$percentChange)
LeveneTest(saFinal$surfaceArea, group = saFinal$ID)

x=saCombo$fragpercentChange
y=saCombo$wildpercentChange

t.test(x, y, paired = TRUE, alternative = "two.sided")




# 	Paired t-test
# 
# data:  x and y
# t = 2.8891, df = 5, p-value = 0.03422
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#   2.981955 51.118195
# sample estimates:
# mean of the differences 
#                27.05007 
mean(saCombo$fragpercentChange)

mean(saCombo$wildpercentChange)


```


### Visualizing Data

We are visualizing the data as bar graphs using the package `ggplot2`


```{r, plots, include = TRUE}

# saFragPlot <- ggplot(saFrag, aes(x = timePoint, y = surfaceArea, fill = geno))+
#   geom_bar(stat = 'identity', position = 'dodge')+
#   facet_wrap(geno~.)+
#   labs(title = 'frag')
# 
# saWildPlot <- ggplot(saWild, aes(x = timePoint, y = surfaceArea, fill = geno ))+
#   geom_bar(stat = 'identity', position = 'dodge')+
#   facet_wrap(geno~.)+
#   labs(title = 'wild')
# 
# 
# comboPlot <- saFragPlot + saWildPlot




percentChangePlot <- ggplot(saChange, aes(x = geno, y = percentChange, fill = ID ))+
  geom_bar(stat = 'identity', position = 'dodge')+
  ylim(-50, 100)


ggsave("../figures/Fig1.png", plot = percentChangePlot, height = 5, width = 9, units = 'in',dpi = 600)




```
***
# Further data exploration
We are going to further explore this data while running an anova and keeping our trials separate. The data is not normally distributed (see the results of the SW test and Levene's test), so we will be running a non-parametric PERMANOVA (permutational analysis of variance) using the `adonis()` function from the package `vegan` and the accompanying post-hoc test `pairwise.adonis` using the package `pairwiseAdonis`.


```{r, PERMANOVA, include = TRUE}


saFragAov <- saClean %>% 
  select(timePoint, geno, ID, trial, surfaceArea) %>% 
  dplyr::filter(ID %in% 'frag') %>%
  dplyr::group_by(timePoint,geno,ID,trial)

saWildAov <- saClean %>% 
  dplyr::filter(ID %in% 'wild') %>% 
  select(timePoint, geno, ID, trial, surfaceArea) %>% 
  dplyr::group_by(timePoint,geno,ID,trial)


# saCombo <- left_join(saFrag, saWild, by = c("timePoint","geno"), copy = FALSE) %>% 
  # dplyr::rename(fragSA = surfaceArea.x) %>% 
  # dplyr::rename(wildSA = surfaceArea.y)

saComboAov <- bind_rows(saFragAov,saWildAov)


saFinalAov <- saComboAov %>% 
  dplyr::filter(timePoint %in% c("0","4")) %>%
  select(c('timePoint','geno','ID','trial','surfaceArea'))


saChangeAov <- dcast(saFinalAov, geno+ID+trial~timePoint) 

saChangeAov <- dplyr::rename(saChangeAov, "initialSurfaceArea" = "0", "finalSurfaceArea" = "4")
saChangeAov
saChangeAov$percentChange <- ((saChangeAov$finalSurfaceArea-saChangeAov$initialSurfaceArea)/saChangeAov$initialSurfaceArea)*100


saFragTestAov <- saChangeAov %>% 
  select(geno, ID, percentChange) %>% 
  dplyr::filter(ID %in% 'frag') %>%
  dplyr::group_by(geno,ID)
  #dplyr::summarise(sum(surfaceArea)) %>% 
  #dplyr::rename("surfaceArea" = "sum(surfaceArea)")


saWildTestAov <- saChangeAov %>% 
  dplyr::filter(ID %in% 'wild') %>% 
  select(geno, ID, percentChange)


saComboAov <- left_join(saFragTestAov, saWildTestAov, by = c("geno"), copy = FALSE) %>% 
  dplyr::rename(fragpercentChange = percentChange.x) %>% 
  dplyr::rename(wildpercentChange = percentChange.y)

shapiro.test(saFinalAov$surfaceArea)
LeveneTest(saFinalAov$surfaceArea, group = saFinalAov$ID)


kruskal.test(percentChange ~ ID, data = saChangeAov)

dunnTest(percentChange ~ ID, data = saChangeAov)



summary(aov(percentChange ~ ID * geno, data = saChangeAov))

# running the PERMANOVA
set.seed(999)
changePerm <- adonis(formula = percentChange ~ geno*ID, data = saChangeAov, method = "euclidian", permutations = 9999, na.rm = TRUE)
changePerm


plotFrags <- saChangeAov %>% 
  filter(ID %in% 'frag')
plotWilds <-saChangeAov %>% 
  filter(ID %in% 'wild')


percentChangeFragPlotAov <- ggplot(plotFrags, aes(x = geno, y = percentChange))+
  geom_bar(stat = 'identity', position = 'dodge', fill = 'darkorchid3')+
  ylim(-50, 100)+
  facet_wrap(trial~.)

percentChangeWildPlotAov <- ggplot(plotWilds, aes(x = geno, y = percentChange))+
 geom_bar(stat = 'identity', position = 'dodge', fill = 'darkorange3')+
  ylim(-50, 100)


comboPlotAov <- percentChangeFragPlotAov + percentChangeWildPlotAov


ggsave("../figures/Fig2.png", plot = percentChangeFragPlotAov, height = 5, width = 9, units = 'in',dpi = 600)

```







